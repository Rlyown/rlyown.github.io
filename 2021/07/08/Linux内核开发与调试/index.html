<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Linux内核开发与调试 - Real Own</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Chaos Chen"><meta name="msapplication-TileImage" content="/img/f7.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Chaos Chen"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="记录Linux内核模块编写的前期准备工作"><meta property="og:type" content="blog"><meta property="og:title" content="Linux内核开发与调试"><meta property="og:url" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/"><meta property="og:site_name" content="Real Own"><meta property="og:description" content="记录Linux内核模块编写的前期准备工作"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722200803854.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722201000862.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722201246597.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722202626076.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722202917787.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723094636612.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722210640983.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722210740326.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722211001348.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722211605797.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707234956778.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707235510649.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723102545525.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723100735999.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723101133777.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723101458549.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210721003403750.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210721003617709.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723102051498.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707222058772.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707234342131.png"><meta property="og:image" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707234459578.png"><meta property="article:published_time" content="2021-07-07T16:01:04.000Z"><meta property="article:modified_time" content="2023-06-30T09:29:04.603Z"><meta property="article:author" content="Chaos Chen"><meta property="article:tag" content="Linux"><meta property="article:tag" content="IMA/EVM"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722200803854.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/"},"headline":"Linux内核开发与调试","image":["https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722200803854.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722201000862.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722201246597.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722202626076.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722202917787.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723094636612.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722210640983.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722210740326.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722211001348.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722211605797.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707234956778.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707235510649.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723102545525.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723100735999.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723101133777.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723101458549.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210721003403750.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210721003617709.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723102051498.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707222058772.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707234342131.png","https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707234459578.png"],"datePublished":"2021-07-07T16:01:04.000Z","dateModified":"2023-06-30T09:29:04.603Z","author":{"@type":"Person","name":"Chaos Chen"},"publisher":{"@type":"Organization","name":"Real Own","logo":{"@type":"ImageObject","url":"https://rlyown.github.io/img/f7.png"}},"description":"记录Linux内核模块编写的前期准备工作"}</script><link rel="canonical" href="https://rlyown.github.io/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/"><link rel="alternate" href="/atom.xml" title="Real Own" type="application/atom+xml"><link rel="icon" href="/img/f7.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/f7.png" alt="Real Own" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Rlyown/rlyown.github.io"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Publié il y a&nbsp;<time dateTime="2021-07-07T16:01:04.000Z" title="7/8/2021, 12:01:04 AM">2021-07-08</time></span><span class="level-item">Mis à jour il y a&nbsp;<time dateTime="2023-06-30T09:29:04.603Z" title="6/30/2023, 5:29:04 PM">2023-06-30</time></span><span class="level-item"><a class="link-muted" href="/categories/Operating-System/">Operating System</a></span><span class="level-item">26 minutes de lecture (Environ 3965 mots)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visites</span></div></div><h1 class="title is-3 is-size-4-mobile">Linux内核开发与调试</h1><div class="content"><h2 id="内核调试"><a href="#内核调试" class="headerlink" title="内核调试"></a>内核调试</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li><p>主机：Ubuntu 20.04.1 – 5.8.0-59-generic</p>
</li>
<li><p>内核源码：linux-5.4.120</p>
</li>
<li><p>GCC：9.3.0</p>
</li>
<li><p>Arch：x86_64</p>
</li>
<li><p>BusyBox</p>
</li>
<li><p>QEMU</p>
<p>在 Ubuntu 20.04 版本下不能直接通过<code>sudo apt install qemu</code>一次性全部安装。</p>
<p>因此需要分包安装，这里安装需要的<code>sudo apt install qemu-system-x86_64</code>。</p>
</li>
</ul>
<h3 id="配置过程"><a href="#配置过程" class="headerlink" title="配置过程"></a>配置过程</h3><p>具体的可以参照<a href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99">相关资料</a>[1-3]，这里简述一下他们的过程。</p>
<h4 id="开启内核-Debug-功能"><a href="#开启内核-Debug-功能" class="headerlink" title="开启内核 Debug 功能"></a>开启内核 Debug 功能</h4><ol>
<li><code>make menuconfig</code>后选择<code>Kernel hacking  ---&gt;</code>选项</li>
</ol>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722200803854.png" class="">

<ol start="2">
<li>选择<code>Compile-time checks and compiler options  ---&gt;</code></li>
</ol>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722201000862.png" class="">

<ol start="3">
<li>选中<code> Compile the kernel with debug info</code>和<code>Provide GDB scripts for kernel debugging</code>两个选项</li>
</ol>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722201246597.png" class="">

<h4 id="构建-initramfs-根文件系统-–-Busybox-方式"><a href="#构建-initramfs-根文件系统-–-Busybox-方式" class="headerlink" title="构建 initramfs 根文件系统 – Busybox 方式"></a>构建 initramfs 根文件系统 – Busybox 方式</h4><p><strong>这种方式的优点在于建构快速，而且十分轻量；但是最大的问题也在于太过简易，会存在一定的功能缺失，比如通过 QEMU 添加的设备无法识别。</strong></p>
<blockquote>
<p>initramfs 的唯一目的是挂载根文件系统。在引导时，引导加载程序将内核和 initramfs 映像加载到内存中并启动内核。内核检查是否存在 initramfs，如果找到，将其挂载为 &#x2F; 并运行 &#x2F;init。</p>
</blockquote>
<p>这里借助<code>Busybox</code>构建简易的 initramfs 根文件系统。编译<code>Busybox</code>的步骤：</p>
<ol>
<li>编译选项：<code>make menuconfig</code> —&gt; <code>Settings</code> —&gt; <code>Build static binary (no shared libs)</code></li>
</ol>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722202626076.png" class="">

<ol start="2">
<li><code>make -j$(nproc)</code></li>
<li><code>make install</code></li>
</ol>
<p>安装完成以后目录下会有一个<code>_install</code>文件夹</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722202917787.png" class="">

<p>根据<code>_install</code>文件夹创建一个<code>initramfs</code>。<code>initramfs</code>文件夹可以在任意目录。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r _install initramfs</span><br><span class="line"><span class="built_in">cd</span> initramfs</span><br><span class="line"></span><br><span class="line"><span class="built_in">ln</span> -s bin/busybox init</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -pv &#123;bin,sbin,etc,proc,sys,usr/&#123;bin,sbin&#125;,dev,lib,lib64&#125;</span><br><span class="line"><span class="built_in">rm</span> linuxrc</span><br></pre></td></tr></table></figure>

<p>链接的 init 程序首先会访问 etc&#x2F;inittab 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> etc</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;::sysinit:/etc/init.d/rcS&quot;</span> &gt; inittab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;::askfirst:-/bin/sh&quot;</span> &gt;&gt; inittab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;::restart:/sbin/init&quot;</span> &gt;&gt; inittab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;::ctrlaltdel:/sbin/reboot&quot;</span> &gt;&gt; inittab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;::shutdown:/bin/umount -a -r&quot;</span> &gt;&gt; inittab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;::shutdown:/sbin/swapoff -a&quot;</span> &gt;&gt; inittab</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x inittab</span><br></pre></td></tr></table></figure>

<p>然后紧接着编写 inittab 所需的 rcS 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> init.d</span><br><span class="line"><span class="built_in">cd</span> init.d</span><br><span class="line">vim rcS</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x rcS</span><br></pre></td></tr></table></figure>

<p><strong>rcS</strong>内容如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mount proc</span><br><span class="line">mount -o remount,rw /</span><br><span class="line">mount -a</span><br><span class="line">clear</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;My Tiny Linux Start :D ......&quot;</span></span><br></pre></td></tr></table></figure>

<p>由于<code>mount -a</code>命令会自动挂载*&#x2F;etc&#x2F;fstab* 文件内的文件系统。因此需要编写 fstab 文件，这里分别挂载常用的四个文件系统。fstab 内容如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/fstab</span></span><br><span class="line">proc            /proc        proc    defaults          0       0</span><br><span class="line"></span><br><span class="line">sysfs           /sys         sysfs   defaults          0       0</span><br><span class="line"></span><br><span class="line">devtmpfs        /dev         devtmpfs  defaults          0       0</span><br><span class="line"></span><br><span class="line">securityfs      /sys/kernel/security    securityfs      rw,relatime     0 0</span><br></pre></td></tr></table></figure>

<p>打包<code>initramfs</code>文件夹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此时位于initramfs文件夹内</span></span><br><span class="line">find . -print0 | cpio --null -ov --format=newc | gzip -9 &gt; ../initramfs.cpio.gz</span><br></pre></td></tr></table></figure>

<h4 id="构建-initramfs-根文件系统-–-rootfs-方式"><a href="#构建-initramfs-根文件系统-–-rootfs-方式" class="headerlink" title="构建 initramfs 根文件系统 – rootfs 方式"></a>构建 initramfs 根文件系统 – rootfs 方式</h4><p><strong>这种方式的优点在于系统结构完整，拥有完整操作系统的使用体验；但是缺点在于修改构建较为复杂。另外，这种方式下，可以检测到 QEMU 挂载的设备。</strong></p>
<p>具体的可以参照<a href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99">相关资料</a>[12]，这里简述一下其过程。</p>
<p>首先在<a target="_blank" rel="noopener" href="http://cdimage.ubuntu.com/cdimage/ubuntu-base/releases/20.04/release/">http://cdimage.ubuntu.com/cdimage/ubuntu-base/releases/20.04/release/</a>，下载一个 ubuntu 文件系统的 base 包，这里面包含一些基础的目录结构以及文件。</p>
<p>然后创建一个磁盘镜像来装载 base 包中的文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 大小可以稍大一些，避免出现空间不足的问题，这里实际创建大小约11G左右</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=rootfs.img bs=10240 count=1M</span><br><span class="line"><span class="comment"># 对其进行格式化</span></span><br><span class="line">mkfs.ext4 -F -L linuxroot rootfs.img</span><br></pre></td></tr></table></figure>

<p>为了把 base 包放入镜像中，需要将其挂。然后将下载好的 base 包解压到磁盘中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要管理员权限</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> /mnt/tmpdir</span><br><span class="line">sudo mount -o loop rootfs.img /mnt/tmpdir/</span><br><span class="line">tar -zxvf ubuntu-base-20.04.1-base-amd64.tar.gz -C /mnt/tmpdir/</span><br></pre></td></tr></table></figure>

<p>然后为了在其上安装必要的基础程序，先配置好 DNS，以及挂载必要的文件系统。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/resolv.conf /mnt/tmpdir/etc/</span><br><span class="line">sudo mount -t proc /proc /mnt/tmpdir/proc</span><br><span class="line">sudo mount -t sysfs /sys /mnt/tmpdir/sys</span><br><span class="line">sudo mount -o <span class="built_in">bind</span> /dev /mnt/tmpdir/dev</span><br><span class="line">sudo mount -o <span class="built_in">bind</span> /dev/pts /mnt/tmpdir/dev/pts</span><br></pre></td></tr></table></figure>

<p>挂在好之后，修改根目录。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chroot</span> /mnt/tmpdir</span><br></pre></td></tr></table></figure>

<p>然后安装必要的软件。以下的软件如果不全部安装，则在启动虚拟机时，会启动失败。以下软件全部安装大概需要 800MB+的空间，因此最初的磁盘不能创建过小。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install language-pack-en-base sudo \</span><br><span class="line">    ssh net-tools ethtool wireless-tools \</span><br><span class="line">    ifupdown network-manager iputils-ping \</span><br><span class="line">    rsyslog htop vim xinit xorg alsa-utils \</span><br><span class="line">    --no-install-recommends</span><br></pre></td></tr></table></figure>

<p>然后给 root 设置一个密码，不然启动虚拟机之后会出现无法登录的尴尬问题。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据提示输入新密码即可</span></span><br><span class="line">passwd root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果添加了新用户，也可以用该方式设置新用户的密码</span></span><br><span class="line">passwd &lt;user&gt;</span><br></pre></td></tr></table></figure>

<p>最后配置下必要的路由信息和主机名。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;host&quot;</span> &gt; /etc/hostname</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;127.0.0.1 localhost&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>至此基本的配置已经结束。如果有需要可以自行通过<code>apt-get</code>工具下载所需的软件，或是修改本地的配置文件。按下<code>Ctrl D</code>即可退出 chroot 的根目录，回到之前的根目录。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo umount /mnt/tmpdir/proc/</span><br><span class="line">sudo umount /mnt/tmpdir/sys/</span><br><span class="line">sudo umount /mnt/tmpdir/dev/pts/</span><br><span class="line">sudo umount /mnt/tmpdir/dev/</span><br><span class="line">sudo umount /mnt/tmpdir/</span><br></pre></td></tr></table></figure>

<h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><p>通过 QEMU 启动内核</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Busybox方式</span></span><br><span class="line">qemu-system-x86_64 -s -kernel /path/to/vmlinux -initrd /path/to/initramfs.cpio.gz -nographic -append <span class="string">&quot;console=ttyS0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rootfs方式</span></span><br><span class="line">qemu-system-x86_64 -s -kernel /path/to/vmlinux -hda /path/to/rootfs.img -nographic -append <span class="string">&quot;root=/dev/sda console=ttyS0&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>-s</code>：代表<code>-gdb tcp::1234</code>表明启动一个 gdbserver 并监听端口 1234</li>
<li><code>-kernel</code>：执行内核程序<code>vmlinux</code></li>
<li><code>-initrd</code>：指定 initramfs 根文件系统</li>
<li><code>-hda</code>：指定一个文件作为硬盘 0。</li>
<li><code>-nographic</code>：取消 QEMU 的图形输出</li>
<li><code>-append</code>：设置内核启动的 CMDLINE。这里将输出重定向到 console，将会显示在标准输出 stdio。</li>
</ul>
<p>执行后的根目录，与 initramfs 文件夹一致</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723094636612.png" class="">

<p>一些发行版可能会限制 gdb 脚本的自动加载到已知的安全目录。如果 gdb 报告拒绝加载 <code>vmlinux-gdb.py</code>，执行下列命令。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;add-auto-load-safe-path /path/to/linux-build&quot;</span> &gt;&gt; ~/.gdbinit</span><br></pre></td></tr></table></figure>

<p>然后启动 GDB</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb /path/to/vmlinux</span><br><span class="line">(gdb) target remote :1234</span><br></pre></td></tr></table></figure>

<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722210640983.png" class="">

<p>查看内核提供的 GDB 辅助调试功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) lx-symbols</span><br></pre></td></tr></table></figure>

<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722210740326.png" class="">

<p>获取当前进程的 pid</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p <span class="variable">$lx_current</span>().pid</span><br></pre></td></tr></table></figure>

<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722211001348.png" class="">

<p>在函数<code>cmdline_proc_show</code>设置断点，然后在 QEMU 虚拟机内执行<code>cat /proc/cmdline</code>触发断点。触发了之后就可以像普通程序的调试那样调试内核。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b cmdline_proc_show</span><br><span class="line">Breakpoint 1 at 0xffffffff813660e0: file fs/proc/cmdline.c, line 8.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br></pre></td></tr></table></figure>

<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210722211605797.png" class="">

<p><strong>最后，如果需要关闭 QEMU 虚拟机，可以在虚拟机使用<code>poweroff</code>命令关机。</strong></p>
<h2 id="内核模块编写"><a href="#内核模块编写" class="headerlink" title="内核模块编写"></a>内核模块编写</h2><h3 id="添加自定义模块"><a href="#添加自定义模块" class="headerlink" title="添加自定义模块"></a>添加自定义模块</h3><p>这里添加的内核模块，并不是指在用户态编写并编译完成之后通过 insmod 安装的模块，而是指直接在内核源码中编写的模块，并通过 make 命令一同编译。</p>
<p><strong>以自定义的 hello 模块为例。</strong>该模块位于<em>security&#x2F;integrity&#x2F;hello</em>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> security/integrity/hello</span><br><span class="line"><span class="built_in">cd</span> security/integrity/hello</span><br><span class="line"><span class="comment"># Makefile用于指定编译的规则</span></span><br><span class="line"><span class="built_in">touch</span> Makefile</span><br><span class="line"><span class="comment"># Kconfig用于处理menuconfig中需用到的相关变量</span></span><br><span class="line"><span class="built_in">touch</span> Kconfig</span><br><span class="line"><span class="comment"># 源码文件</span></span><br><span class="line"><span class="built_in">touch</span> hello_main.c</span><br></pre></td></tr></table></figure>

<h4 id="Kconfig"><a href="#Kconfig" class="headerlink" title="Kconfig"></a>Kconfig</h4><p>首先打开<em>security&#x2F;integrity&#x2F;Kconfig</em>，在其末尾添加上 hello 的 Kconfig 路径。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source &quot;security/integrity/ima/Kconfig&quot;</span><br><span class="line">source &quot;security/integrity/evm/Kconfig&quot;</span><br><span class="line">source &quot;security/integrity/hello/Kconfig&quot;</span><br></pre></td></tr></table></figure>

<p>然后仿照格式编写一个简单的 Kconfig 在<em>security&#x2F;integrity&#x2F;hello&#x2F;Kconfig</em>目录下。</p>
<p>这里只是一个极简的写法，表明仅有一个 bool 参数，默认值为 n。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config HELLO</span><br><span class="line">    bool &quot;hello world module&quot;</span><br><span class="line">    default n</span><br><span class="line">    help</span><br><span class="line">      Enable hello world module</span><br></pre></td></tr></table></figure>

<h4 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h4><p>同样先处理父级目录<em>security&#x2F;integrity&#x2F;Makefile</em>，添加 hello。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj-<span class="variable">$(CONFIG_IMA)</span>           += ima/</span><br><span class="line">obj-<span class="variable">$(CONFIG_EVM)</span>           += evm/</span><br><span class="line">obj-<span class="variable">$(CONFIG_HELLO)</span>			+= hello/</span><br></pre></td></tr></table></figure>

<p>然后仿照 ima 的 makefile 编写<em>security&#x2F;integrity&#x2F;hello&#x2F;Makefile</em>。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj-<span class="variable">$(CONFIG_HELLO)</span> += hello.o</span><br><span class="line"></span><br><span class="line">hello-y := hello_main.o</span><br></pre></td></tr></table></figure>

<p>这种 Makefile 写法的解释可以参照<a href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99">相关资料</a>[6-8]。简单来说就是，当变量的值为<code>y</code>或<code>m</code>时，表示编译这个对象。也即根据<code>hello-y</code>编译<code>hello.o</code>，然后如果<code>$(CONFIG_HELLO)</code>为<code>y</code>则会将<code>hello.o</code>编译进内核。</p>
<h4 id="hello-main-c"><a href="#hello-main-c" class="headerlink" title="hello_main.c"></a>hello_main.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">init_hello</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	printk(KERN_ALERT <span class="string">&quot;hello world test!&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">late_initcall(init_hello);</span><br></pre></td></tr></table></figure>

<p>这里的<code>late_initcall</code>涉及到一个内核初始化顺序的问题。</p>
<p>这个初始化的优先级由<em>include&#x2F;linux&#x2F;init.h</em>文件定义，数字越小优先级越高。</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707234956778.png" class="">

<p>这里还存在一个常见的内核模块初始化级别<code>module_init</code>（位于<em>include&#x2F;linux&#x2F;module.h</em>）。</p>
<p>结合上面的截图，不难看出<code>module_init</code>的初始化级别等同于<code>device_initcall</code>。</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707235510649.png" class="">

<p>按初始化顺序排序：</p>
<ul>
<li>early_initcall</li>
<li>pure_initcall</li>
<li>core_initcall</li>
<li>postcore_initcall</li>
<li>arch_initcall</li>
<li>subsys_initcall</li>
<li>fs_initcall</li>
<li>rootfs_initcall</li>
<li>device_initcall、module_init</li>
<li>late_initcall</li>
</ul>
<h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p>“hello world module”选项即为配置的 hello 模块的 CONFIG_HELLO 参数。</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723102545525.png" class="">

<p>编译并启动内核，可以在<code>dmesg</code>中看到 hello 模块输出的信息</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723100735999.png" class="">

<h2 id="在调试环境下执行程序"><a href="#在调试环境下执行程序" class="headerlink" title="在调试环境下执行程序"></a>在调试环境下执行程序</h2><p>由于之前通过 busybox 创建的简易的文件系统<code>initramfs</code>包含的内容太少，无法直接在里面运行的第三方程序或者是编译 C 程序。</p>
<p>比如实现了一个函数叫<code>clone_hook</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">clone_hook</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    printk(<span class="string">&quot;[clone hook] called by clone!&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>kernel/nsproxy.c</code>文件中被调用，即在 clone 调用的相关函数<code>copy_namespaces</code>中添加<code>clone_hook</code>函数的调用。</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723101133777.png" class="">

<p>如果想要测试<code>clone_hook</code>的执行，就需要去执行<code>clone</code>系统调用。这个在正常的操作系统下是没有问题的，但如果使用的是<a href="#%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95">内核调试</a>部分创建的简易文件系统的话，则会执行失败。</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723101458549.png" class="">

<p>如上图所示，如果执行成功则会出现*[clone hook] called by clone!*的信息。然而并没有。（<code>clone_test</code>程序的作用是：执行<code>clone</code>系统调用）</p>
<p>这个问题出现的主要因素在于：<strong>clone_test.c 是使用了 C 标准库编写的，自制的 initramfs 文件系统里缺少相关的动态链接库，从而导致了执行的失败。</strong></p>
<p>通过<code>ldd</code>命令查询<code>clone_test</code>程序所需的动态链接库</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210721003403750.png" class="">

<p>然后在自制的<code>initramfs</code>目录下，创建同名的<code>lib</code>以及<code>lib64</code>目录。并将所需的动态链接库拷贝到相同的位置。</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210721003617709.png" class="">

<p>最后重新打包<code>initramfs.cpio.gz</code>文件，并执行<code>clone_test</code>。这次就可以看到<code>clone_hook</code>成功执行，以及<code>clone_test</code>程序也成功打印出了子进程的<code>pid</code>。</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210723102051498.png" class="">

<p><strong>clone_test.c</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> child_stack[<span class="number">5000</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">grchild</span><span class="params">(<span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;child(%d) in ns my PID: %d Parent ID=%d\n&quot;</span>, num, getpid(),getppid());</span><br><span class="line">  sleep(<span class="number">5</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;end child&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">child_fn</span><span class="params">(<span class="type">int</span> ppid)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;PID: %ld Parent:%ld\n&quot;</span>, (<span class="type">long</span>)getpid(), getppid());</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)</span><br><span class="line">  &#123;</span><br><span class="line">   	<span class="keyword">if</span>(fork() == <span class="number">0</span>)</span><br><span class="line">  	&#123;</span><br><span class="line">  		grchild(i+<span class="number">1</span>);</span><br><span class="line">  		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  	&#125;</span><br><span class="line">  	kill(ppid,SIGKILL); <span class="comment">// no effect</span></span><br><span class="line">  &#125;</span><br><span class="line">  sleep(<span class="number">2</span>);</span><br><span class="line">  kill(<span class="number">2</span>,SIGKILL); <span class="comment">// kill the first child</span></span><br><span class="line">  sleep(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">pid_t</span> pid = clone(child_fn, child_stack+<span class="number">5000</span>, CLONE_NEWPID , getpid());</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;clone() = %d\n&quot;</span>, pid);</span><br><span class="line"></span><br><span class="line">  waitpid(pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="加快内核编译速度"><a href="#加快内核编译速度" class="headerlink" title="加快内核编译速度"></a>加快内核编译速度</h2><ol start="0">
<li>无任何配置</li>
</ol>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707222058772.png" class="">

<ol>
<li>ccache</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ccache</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$HOME</span></span><br><span class="line">vim .bashrc</span><br><span class="line"><span class="comment">## export USE_CCACHE=1</span></span><br><span class="line"><span class="comment">## export CCACHE_DIR=&quot;$HOME/.ccache&quot;</span></span><br><span class="line"><span class="comment">## export CC=&quot;ccache gcc&quot;</span></span><br><span class="line"><span class="comment">## export CXX=&quot;ccache g++&quot;</span></span><br><span class="line"><span class="comment">## export PATH=&quot;$PATH:/usr/lib/ccache&quot;</span></span><br><span class="line"><span class="built_in">source</span> .bashrc</span><br><span class="line"><span class="comment"># 配置cache的大小</span></span><br><span class="line">ccache -M 30G</span><br><span class="line"><span class="comment"># 使用方法</span></span><br><span class="line">ccache gcc xxx</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">make CC=<span class="string">&#x27;ccache gcc&#x27;</span> -j$(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure>

<p>配置了之后，时间更长了。</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707234342131.png" class="">

<p>缓存的命中率较低，可能这就是导致时间开销更多的原因。</p>
<img src="/2021/07/08/Linux%E5%86%85%E6%A0%B8%E5%BC%80%E5%8F%91%E4%B8%8E%E8%B0%83%E8%AF%95/image-20210707234459578.png" class="">

<ol start="2">
<li><p>initramfs.conf</p>
<p>修改&#x2F;etc&#x2F;initramfs-tools&#x2F;initramfs.conf 配置，MODULES&#x3D;dep，COMPRESS&#x3D;lzop</p>
</li>
</ol>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>附上一个构建脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print_help</span></span>() &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Usage: run_kernel.sh [-a &lt;append&gt;] (-m/t) &lt;method&gt;&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;    -h: Show this message.&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;    -a: append cmdline argument to the kernel running in the qemu. This argument should set before -m or -t.&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;    -m: Choose method.&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;         &#x27;debug&#x27;: Start a qemu virtual machine. Initrd is created by busybox.&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;         &#x27;init&#x27;: Package the initramfs directory to the initramfs.cpio.gz. It used in qemu.&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;         &#x27;build&#x27;: Build the linux kernel just with stderr. Additionally, it will run make clean before.&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;    -t: rootfs method&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;         &#x27;debug&#x27;: Start a qemu virtual machine with a vtpm device. Initrd is a rootfs.&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;         &#x27;rfs&#x27;: Create the disk.&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;         &#x27;init&#x27;: mount the rootfs to set up.&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;         &#x27;uinit&#x27;: after init, umount the rootfs.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        print_help</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">&quot;hm:a:t:&quot;</span> optname; <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$optname</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">&quot;h&quot;</span>)</span><br><span class="line">                print_help</span><br><span class="line">                ;;</span><br><span class="line">        <span class="string">&quot;a&quot;</span>)</span><br><span class="line">                CMDLINE=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span></span><br><span class="line">                ;;</span><br><span class="line">                <span class="comment"># &quot;i&quot;)</span></span><br><span class="line">                <span class="comment">#     INITRD=&quot;$OPTARG&quot;</span></span><br><span class="line">                <span class="comment">#     if [ -z &quot;$INITRD&quot; ]</span></span><br><span class="line">                <span class="comment">#     then</span></span><br><span class="line">                <span class="comment">#         echo &quot;initrd file is needed!&quot;</span></span><br><span class="line">                <span class="comment">#         print_help</span></span><br><span class="line">                <span class="comment">#         exit 1</span></span><br><span class="line">                <span class="comment">#     elif [ ! -f &quot;$INITRD&quot; ]</span></span><br><span class="line">                <span class="comment">#     then</span></span><br><span class="line">                <span class="comment">#         echo &quot;$INITRD: No such file!&quot;</span></span><br><span class="line">                <span class="comment">#         exit 1</span></span><br><span class="line">                <span class="comment">#     fi</span></span><br><span class="line">                <span class="comment">#     ;;</span></span><br><span class="line">        <span class="string">&quot;m&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>x = <span class="string">&quot;debug&quot;</span>x ]; <span class="keyword">then</span></span><br><span class="line">                        <span class="comment"># if the process &#x27;qemu-system-x86_64&#x27; is running in the background, kill the process</span></span><br><span class="line">                        pid=$(ps -ef | grep <span class="string">&#x27;qemu-system-x86_64&#x27;</span> | grep -v <span class="string">&#x27;grep&#x27;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">                        <span class="keyword">if</span> [ ! <span class="variable">$pid</span> ]; <span class="keyword">then</span></span><br><span class="line">                                <span class="built_in">echo</span> <span class="string">&quot;the process &#x27;qemu-system-x86_64&#x27; is not run!!!&quot;</span></span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                                <span class="built_in">echo</span> <span class="string">&quot;the process &#x27;qemu-system-x86_64&#x27; is running!!!&quot;</span></span><br><span class="line">                                <span class="built_in">kill</span> -9 <span class="variable">$pid</span></span><br><span class="line">                                <span class="built_in">echo</span> <span class="string">&quot;the process &#x27;qemu-system-x86_64&#x27; has been killed!!&quot;</span></span><br><span class="line">                        <span class="keyword">fi</span></span><br><span class="line">                        <span class="built_in">echo</span> run kernel <span class="keyword">in</span> qemu <span class="keyword">for</span> debug</span><br><span class="line">                        qemu-system-x86_64 -m 1024 -enable-kvm -s -kernel ./vmlinux -initrd ./initramfs.cpio.gz -nographic -append <span class="string">&quot;console=ttyS0 <span class="variable">$CMDLINE</span>&quot;</span></span><br><span class="line">                <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>x = <span class="string">&quot;init&quot;</span>x ]; <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> package the initramfs</span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;Copy Device file, permission needed!&quot;</span></span><br><span class="line">                        <span class="built_in">cd</span> initramfs</span><br><span class="line">                        <span class="comment"># sudo rm -rf dev/ proc/ sys/</span></span><br><span class="line">                        <span class="comment"># mkdir sys proc dev</span></span><br><span class="line">                        <span class="comment"># sudo cp -a /dev/&#123;null,console,tty,tty1,tty2,tty3,tty4&#125; dev/</span></span><br><span class="line">                        find . -print0 | cpio --null -ov --format=newc | gzip -9 &gt;../initramfs.cpio.gz</span><br><span class="line">                        <span class="built_in">cd</span> -</span><br><span class="line">                <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>x = <span class="string">&#x27;build&#x27;</span>x ]; <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">echo</span> start build linux kernel</span><br><span class="line">                        time make -j$(<span class="built_in">nproc</span>) &gt;/dev/null</span><br><span class="line">                <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>x = <span class="string">&#x27;disk&#x27;</span>x ]; <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=test.disk bs=512 count=$((<span class="number">32</span> * <span class="number">1024</span> * <span class="number">1024</span> / <span class="number">512</span>))</span><br><span class="line">                        mkfs.ext4 -q test.disk</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        print_help</span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">                ;;</span><br><span class="line">        <span class="string">&quot;t&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>x = <span class="string">&quot;debug&quot;</span>x ]; <span class="keyword">then</span></span><br><span class="line">                        <span class="comment"># qemu-system-x86_64 -enable-kvm \</span></span><br><span class="line">                        <span class="comment">#     -m 1024 -boot d -bios $SEABIOS/bios.bin \</span></span><br><span class="line">                        <span class="comment">#     -tpmdev passthrough,id=tpm0,path=/dev/vtpm0 \</span></span><br><span class="line">                        <span class="comment">#     -device tpm-tis,tpmdev=tpm0 \</span></span><br><span class="line">                        <span class="comment">#     -kernel ./vmlinux -hda ./rootfs.img \</span></span><br><span class="line">                        <span class="comment">#     -nographic -append &quot;root=/dev/sda console=ttyS0 $CMDLINE&quot;</span></span><br><span class="line"></span><br><span class="line">                        qemu-system-x86_64 -m 1024 -enable-kvm -s \</span><br><span class="line">                                -boot d -bios <span class="variable">$SEABIOS_PATH</span>/bios.bin \</span><br><span class="line">                                -kernel ./vmlinux -hda ./rootfs.img \</span><br><span class="line">                                -nographic -append <span class="string">&quot;root=/dev/sda console=ttyS0 <span class="variable">$CMDLINE</span>&quot;</span></span><br><span class="line">                <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>x = <span class="string">&quot;rfs&quot;</span>x ]; <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=rootfs.img bs=10240 count=1M</span><br><span class="line">                        sudo mkfs.ext4 -F -L linuxroot rootfs.img</span><br><span class="line"></span><br><span class="line">                        wget http://cdimage.ubuntu.com/cdimage/ubuntu-base/releases/20.04/release/ubuntu-base-20.04.1-base-amd64.tar.gz -O ubuntu-base-amd64.tar.gz</span><br><span class="line">                        sudo <span class="built_in">rmdir</span> /mnt/tmpdir</span><br><span class="line">                        sudo <span class="built_in">mkdir</span> /mnt/tmpdir</span><br><span class="line">                        sudo mount -o loop rootfs.img /mnt/tmpdir/</span><br><span class="line">                        sudo tar -zxvf ubuntu-base-amd64.tar.gz -C /mnt/tmpdir/</span><br><span class="line"></span><br><span class="line">                        sudo <span class="built_in">cp</span> /etc/resolv.conf /mnt/tmpdir/etc/</span><br><span class="line">                        sudo mount -t proc /proc /mnt/tmpdir/proc</span><br><span class="line">                        sudo mount -t sysfs /sys /mnt/tmpdir/sys</span><br><span class="line">                        sudo mount -o <span class="built_in">bind</span> /dev /mnt/tmpdir/dev</span><br><span class="line">                        sudo mount -o <span class="built_in">bind</span> /dev/pts /mnt/tmpdir/dev/pts</span><br><span class="line"></span><br><span class="line">                        sudo <span class="built_in">chroot</span> /mnt/tmpdir apt-get update &amp;&amp; \</span><br><span class="line">                          apt-get install -y \</span><br><span class="line">                            language-pack-en-base \</span><br><span class="line">                            sudo \</span><br><span class="line">                            ssh \</span><br><span class="line">                            net-tools \</span><br><span class="line">                            ethtool \</span><br><span class="line">                            wireless-tools \</span><br><span class="line">                            ifupdown \</span><br><span class="line">                            network-manager \</span><br><span class="line">                            iputils-ping \</span><br><span class="line">                            rsyslog \</span><br><span class="line">                            htop \</span><br><span class="line">                            vim \</span><br><span class="line">                            xinit xorg \</span><br><span class="line">                            alsa-utils \</span><br><span class="line">                            attr \</span><br><span class="line">                            --no-install-recommends &amp;&amp; \</span><br><span class="line">                          passwd</span><br><span class="line">                <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>x = <span class="string">&quot;init&quot;</span>x ]; <span class="keyword">then</span></span><br><span class="line">                        sudo <span class="built_in">rmdir</span> /mnt/tmpdir</span><br><span class="line">                        sudo <span class="built_in">mkdir</span> /mnt/tmpdir</span><br><span class="line">                        sudo mount -o loop ./rootfs.img /mnt/tmpdir/</span><br><span class="line">                        sudo mount -t proc /proc /mnt/tmpdir/proc</span><br><span class="line">                        sudo mount -t sysfs /sys /mnt/tmpdir/sys</span><br><span class="line">                        sudo mount -o <span class="built_in">bind</span> /dev /mnt/tmpdir/dev</span><br><span class="line">                        sudo mount -o <span class="built_in">bind</span> /dev/pts /mnt/tmpdir/dev/pts</span><br><span class="line">                        sudo <span class="built_in">chroot</span> /mnt/tmpdir</span><br><span class="line">                <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>x = <span class="string">&quot;uinit&quot;</span>x ]; <span class="keyword">then</span></span><br><span class="line">                        sudo umount /mnt/tmpdir/proc/</span><br><span class="line">                        sudo umount /mnt/tmpdir/sys/</span><br><span class="line">                        sudo umount /mnt/tmpdir/dev/pts/</span><br><span class="line">                        sudo umount /mnt/tmpdir/dev/</span><br><span class="line">                        sudo umount /mnt/tmpdir/</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                        print_help</span><br><span class="line">                <span class="keyword">fi</span></span><br><span class="line">                ;;</span><br><span class="line">        <span class="string">&quot;?&quot;</span>)</span><br><span class="line">                print_help</span><br><span class="line">                ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://consen.github.io/2018/01/17/debug-linux-kernel-with-qemu-and-gdb/">使用 QEMU 和 GDB 调试 Linux 内核</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linuxfromscratch.org/blfs/view/svn/postlfs/initramfs.html">About initramfs</a></li>
<li><a target="_blank" rel="noopener" href="https://tupelo-shen.github.io/2020/02/27/Linux%E5%86%85%E6%A0%B80-%E4%BD%BF%E7%94%A8QEMU%E5%92%8CGDB%E8%B0%83%E8%AF%95Linux%E5%86%85%E6%A0%B8/#%E6%9E%84%E5%BB%BAinitramfs%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F">Linux 内核 0-使用 QEMU 和 GDB 调试 Linux 内核</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/dev-tools/gdb-kernel-debugging.rst">Debugging kernel and modules via gdb</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/lizuobin2/article/details/51429937">Linux 内核配置以及 Make menuconfig 过程分析</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_23274715/article/details/104880443">KConfig 使用介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10949986/whats-meaning-of-obj-y-something-in-linux-kernel-makefile">Whats meaning of obj-y +&#x3D; something&#x2F; in linux kernel Makefile?</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/downey-blog/p/10486907.html">linux 内核可加载模块的 makefile</a></li>
<li><a target="_blank" rel="noopener" href="http://cxd2014.github.io/2015/11/11/Linux-Makefile/">Linux 内核的 Makefile</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42082222/article/details/89343709?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_baidulandingword-5&spm=1001.2101.3001.4242">内核初始化的模块顺序</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/kbuild/modules.txt">Documentation&#x2F;kbuild&#x2F;modules.txt</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/jasonLee_lijiaqi/article/details/80967912">QEMU+gdb 调试 Linux 内核全过程</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jeanleo.com/2020/08/30/qemu%E8%B0%83%E8%AF%95%E5%86%85%E6%A0%B8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">Qemu 调试内核环境搭建</a></li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>Linux内核开发与调试</p><p><a href="https://rlyown.github.io/2021/07/08/Linux内核开发与调试/">https://rlyown.github.io/2021/07/08/Linux内核开发与调试/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Chaos Chen</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-07-08</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-06-30</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Linux/">Linux</a><a class="link-muted mr-2" rel="tag" href="/tags/IMA-EVM/">IMA/EVM</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/07/14/LSM%E5%AE%89%E5%85%A8%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">LSM安全模块开发</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/05/29/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%8F%8C%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AETPM%E7%9A%84%E8%BF%87%E7%A8%8B/"><span class="level-item">记一次双系统配置TPM的过程</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Commentaires</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "f5097d9f3226e60e42bc51f5a372b0ee",
            repo: "rlyown.github.io",
            owner: "Rlyown",
            clientID: "0dc9a246a80c473e7d31",
            clientSecret: "08612f9152910db6288e61191a4221bad6aea8e5",
            admin: ["Rlyown"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#内核调试"><span class="level-left"><span class="level-item">1</span><span class="level-item">内核调试</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#环境"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">环境</span></span></a></li><li><a class="level is-mobile" href="#配置过程"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">配置过程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#开启内核-Debug-功能"><span class="level-left"><span class="level-item">1.2.1</span><span class="level-item">开启内核 Debug 功能</span></span></a></li><li><a class="level is-mobile" href="#构建-initramfs-根文件系统-–-Busybox-方式"><span class="level-left"><span class="level-item">1.2.2</span><span class="level-item">构建 initramfs 根文件系统 – Busybox 方式</span></span></a></li><li><a class="level is-mobile" href="#构建-initramfs-根文件系统-–-rootfs-方式"><span class="level-left"><span class="level-item">1.2.3</span><span class="level-item">构建 initramfs 根文件系统 – rootfs 方式</span></span></a></li><li><a class="level is-mobile" href="#调试"><span class="level-left"><span class="level-item">1.2.4</span><span class="level-item">调试</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#内核模块编写"><span class="level-left"><span class="level-item">2</span><span class="level-item">内核模块编写</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#添加自定义模块"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">添加自定义模块</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Kconfig"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">Kconfig</span></span></a></li><li><a class="level is-mobile" href="#Makefile"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">Makefile</span></span></a></li><li><a class="level is-mobile" href="#hello-main-c"><span class="level-left"><span class="level-item">2.1.3</span><span class="level-item">hello_main.c</span></span></a></li></ul></li><li><a class="level is-mobile" href="#效果"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">效果</span></span></a></li></ul></li><li><a class="level is-mobile" href="#在调试环境下执行程序"><span class="level-left"><span class="level-item">3</span><span class="level-item">在调试环境下执行程序</span></span></a></li><li><a class="level is-mobile" href="#加快内核编译速度"><span class="level-left"><span class="level-item">4</span><span class="level-item">加快内核编译速度</span></span></a></li><li><a class="level is-mobile" href="#附录"><span class="level-left"><span class="level-item">5</span><span class="level-item">附录</span></span></a></li><li><a class="level is-mobile" href="#相关资料"><span class="level-left"><span class="level-item">6</span><span class="level-item">相关资料</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/f7.png" alt="Real Own" height="28"></a><p class="is-size-7"><span>&copy; 2023 Chaos Chen</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visité par <span id="busuanzi_value_site_uv">0</span> utilisateurs</span></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-hans");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Retour au sommet" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "Ce site Web utilise des cookies pour améliorer votre expérience.",
          dismiss: "Je l'ai!",
          allow: "Autorise les cookies",
          deny: "Déclin",
          link: "Apprendre encore plus",
          policy: "Politique relative aux cookies",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Sans titre)","posts":"Articles","pages":"Pages","categories":"Catégories","tags":"Tags"});
        });</script></body></html>